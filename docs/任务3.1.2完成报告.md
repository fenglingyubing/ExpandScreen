# 任务3.1.2 完成报告：硬件编码支持（WIN-102）

- **任务ID**: WIN-102
- **优先级**: P0
- **负责人**: Windows工程师2
- **完成日期**: 2026-01-23
- **分支**: vk/1ff8-3-1-2

## 目标

在现有 FFmpeg 软件编码基础上，增加硬件编码能力，并提供稳定的自动选择与回退机制（NVENC > QuickSync > FFmpeg）。

## 实现内容

### 1) NVENC 支持

- 新增 `NvencEncoder`：使用 FFmpeg 编码器 `h264_nvenc`（best-effort，根据运行环境是否包含对应 FFmpeg native 与 GPU 支持决定是否可用）。

### 2) QuickSync 支持

- 新增 `QuickSyncEncoder`：使用 FFmpeg 编码器 `h264_qsv`（best-effort，可用性取决于 FFmpeg native 构建与硬件/驱动支持）。
- 默认目标像素格式设置为 `NV12`（更贴合 QSV 常见输入路径）。

### 3) 自动选择与回退

- 新增 `AutoVideoEncoder`：
  - 在 `Initialize(...)` 阶段按优先级依次尝试 NVENC / QuickSync / FFmpeg；
  - 任一候选初始化失败会记录日志并尝试下一个；
  - 最终保证可用时回退到软件编码，避免仅凭“可用性探测”误判导致直接失败。

### 4) 编码器可用性探测

- 新增 `FFmpegEncoderCapabilities`：
  - 提供 `IsEncoderAvailable(string encoderName)`；
  - 以 best-effort 方式调用 `avcodec_find_encoder_by_name` 进行探测；
  - 当 FFmpeg native 不存在或不可用时不会抛出异常，直接视为不可用，从而触发回退逻辑。

### 5) 现有编码器增强

- 扩展 `FFmpegEncoder`：
  - 支持指定编码器名称（用于硬编）
  - 支持配置目标像素格式（BGRA → 目标格式 via swscale）

## 关键文件

- `src/ExpandScreen.Core/Encode/FFmpegEncoder.cs`
- `src/ExpandScreen.Core/Encode/FFmpegEncoderCapabilities.cs`
- `src/ExpandScreen.Core/Encode/NvencEncoder.cs`
- `src/ExpandScreen.Core/Encode/QuickSyncEncoder.cs`
- `src/ExpandScreen.Core/Encode/AutoVideoEncoder.cs`
- `src/ExpandScreen.Core/Encode/VideoEncoderFactory.cs`

## 说明与限制

- NVENC/QSV 的实际可用性依赖运行环境（FFmpeg native 构建是否包含对应 encoder、GPU/驱动是否支持）；当不可用或初始化失败时会自动回退到 FFmpeg 软件编码。
- 当前实现仍使用 CPU 路径（BGRA → swscale → 目标像素格式）；D3D11 纹理零拷贝路径作为后续性能优化项。

