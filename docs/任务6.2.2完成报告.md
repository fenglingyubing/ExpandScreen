# 任务6.2.2（REL-002）Android 发布包 - 完成报告

## 任务信息

- **任务ID**: REL-002
- **优先级**: P0
- **负责人**: Android工程师1
- **状态**: ✅ 已完成
- **完成日期**: 2026-01-26

## 目标

为 ExpandScreen Android 端提供可复用的 Release 构建与签名流程，确保：

- Release buildType（R8/ProGuard 混淆 + 资源优化 + APK 瘦身）
- 生成签名 Release APK（支持本地与 CI 注入签名配置）
- 多架构输出（`ARM64` / `ARMv7`，`x86_64` 可选）
- 可一键产出发布产物并留存到 staging 目录

## 实现内容

### 1) Release 构建配置（R8/资源瘦身/zipalign）

更新：`android-client/app/build.gradle.kts`

- Release：
  - `minifyEnabled = true`
  - `shrinkResources = true`
  - 使用 `proguard-android-optimize.txt` + `proguard-rules.pro`

### 2) 签名配置（本地文件 / 环境变量）

更新：`android-client/app/build.gradle.kts`

- 本地（推荐）：`android-client/keystore.properties`（仓库已忽略，参考 `android-client/keystore.properties.example`）
- CI（环境变量）：
  - `ANDROID_KEYSTORE_FILE`
  - `ANDROID_KEYSTORE_PASSWORD`
  - `ANDROID_KEY_ALIAS`
  - `ANDROID_KEY_PASSWORD`

> 说明：当未提供签名配置时，Release 构建仍可产出（用于验证构建链路），但不会绑定 release signing config。

### 3) 多 ABI 输出（ARM64/ARMv7，x86_64 可选）

更新：`android-client/app/build.gradle.kts`

- 默认输出：`arm64-v8a` / `armeabi-v7a`
- 可选 x86_64：`-PincludeX86_64=true`

### 4) 一键构建脚本与产物 staging

新增：`scripts/release/android/Build-AndroidRelease.ps1`

- 执行 `:app:assembleRelease`
- 将 `app/build/outputs/apk/release` 下 APK 与 `output-metadata.json` 复制到：
  - `artifacts/android/apk/<versionName>-<versionCode>/`

### 5) 文档同步

- 更新：`docs/developer/RELEASE.md`（补齐 Android 发布包说明）
- 更新：`docs/开发流程文档.md`（补齐 6.2.2 记录）

## 使用方式

### 1) 配置签名

在 `android-client/` 下创建 `keystore.properties`（参考 `android-client/keystore.properties.example`）。

### 2) 一键构建（推荐）

```powershell
./scripts/release/android/Build-AndroidRelease.ps1
```

### 3) 可选：包含 x86_64

```powershell
./scripts/release/android/Build-AndroidRelease.ps1 -IncludeX86_64
```

## 构建/测试记录（本地）

- JDK：`F:\Java\jdk-21`
- 单测：`pushd android-client; $env:JAVA_HOME="F:\\Java\\jdk-21"; $env:Path="$env:JAVA_HOME\\bin;$env:Path"; .\\gradlew.bat :app:testDebugUnitTest --no-daemon; popd`
  - 结果：✅ `BUILD SUCCESSFUL`（2m 2s）
- Release 构建（签名 + ABI splits）：`$env:JAVA_HOME="F:\\Java\\jdk-21"; $env:Path="$env:JAVA_HOME\\bin;$env:Path"; ./scripts/release/android/Build-AndroidRelease.ps1`
  - 结果：✅ `BUILD SUCCESSFUL`（3m 40s）
  - 产物：`artifacts/android/apk/1.0.0-1/app-arm64-v8a-release.apk`、`artifacts/android/apk/1.0.0-1/app-armeabi-v7a-release.apk`
