<Window x:Class="ExpandScreen.UI.Views.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:ExpandScreen.UI.Converters"
        xmlns:svc="clr-namespace:ExpandScreen.UI.Services"
        Title="设置"
        Height="560"
        Width="760"
        MinHeight="400"
        MinWidth="680"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="CanResize"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <conv:ConfigEnumDisplayConverter x:Key="ConfigEnumDisplayConverter"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <Style x:Key="SettingsLabelStyle" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="{DynamicResource UIFont}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
        </Style>

        <Style x:Key="SettingsValueStyle" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="{DynamicResource UIFont}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        </Style>

        <Style x:Key="SettingsTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontFamily" Value="{DynamicResource MonoFont}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Margin" Value="0,6,0,0"/>
        </Style>

        <Style x:Key="SettingsComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontFamily" Value="{DynamicResource UIFont}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Margin" Value="0,6,0,0"/>
        </Style>

        <Style x:Key="SettingsTabItemStyle" TargetType="TabItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="FontFamily" Value="{DynamicResource UIFont}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="tab"
                                Background="Transparent"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="999"
                                Padding="14,8">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="tab" Property="Background" Value="{DynamicResource PrimaryGradientBrush}"/>
                                <Setter TargetName="tab" Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="tab" Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Border Background="{DynamicResource BackgroundBrush}"
            CornerRadius="12"
            Margin="8">
        <Border.Effect>
            <DropShadowEffect Color="Black" BlurRadius="20" ShadowDepth="0" Opacity="0.4"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="48"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Title Bar -->
            <Border Grid.Row="0"
                    Background="{DynamicResource SurfaceBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    CornerRadius="12,12,0,0"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <TextBlock Text="设置"
                               FontFamily="{DynamicResource UIFont}"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               VerticalAlignment="Center"
                               Margin="20,0"/>

                    <Button Style="{DynamicResource IconButtonStyle}"
                            Click="CloseButton_Click"
                            HorizontalAlignment="Right"
                            Margin="0,0,8,0"
                            ToolTip="关闭">
                        <TextBlock Text="✕" FontSize="14"/>
                    </Button>
                </Grid>
            </Border>

            <!-- Content -->
            <Grid Grid.Row="1" Margin="24">
                <TabControl Background="Transparent"
                            BorderThickness="0"
                            Padding="0">
                    <TabControl.Resources>
                        <Style TargetType="TabItem" BasedOn="{StaticResource SettingsTabItemStyle}"/>
                    </TabControl.Resources>

                    <TabItem Header="常规">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Grid Margin="0,16,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="260"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <Border Style="{DynamicResource CardStyle}" Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="启动与行为"
                                                       FontFamily="{DynamicResource UIFont}"
                                                       FontSize="16"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       Margin="0,0,0,14"/>

                                            <Grid Margin="0,0,0,12">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="开机自启动" Style="{StaticResource SettingsValueStyle}"/>
                                                    <TextBlock Text="Windows 启动后自动运行 ExpandScreen" Style="{StaticResource SettingsLabelStyle}" Margin="0,4,0,0"/>
                                                </StackPanel>
                                                <CheckBox Grid.Column="1" VerticalAlignment="Center" IsChecked="{Binding AutoStart}"/>
                                            </Grid>

                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="最小化到托盘" Style="{StaticResource SettingsValueStyle}"/>
                                                    <TextBlock Text="关闭按钮将隐藏窗口，不退出程序" Style="{StaticResource SettingsLabelStyle}" Margin="0,4,0,0"/>
                                                </StackPanel>
                                                <CheckBox Grid.Column="1" VerticalAlignment="Center" IsChecked="{Binding MinimizeToTray}"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <Border Style="{DynamicResource CardStyle}">
                                        <StackPanel>
                                            <TextBlock Text="外观"
                                                       FontFamily="{DynamicResource UIFont}"
                                                       FontSize="16"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       Margin="0,0,0,14"/>

                                            <TextBlock Text="主题" Style="{StaticResource SettingsLabelStyle}"/>
                                            <ComboBox Style="{StaticResource SettingsComboBoxStyle}"
                                                      ItemsSource="{Binding ThemeOptions}"
                                                      SelectedItem="{Binding Theme}">
                                                <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Converter={StaticResource ConfigEnumDisplayConverter}}"/>
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                            <TextBlock Text="切换主题会实时预览；取消可自动回退。"
                                                       Style="{StaticResource SettingsLabelStyle}"
                                                       Margin="0,8,0,0"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>

                                <Border Grid.Column="1" Style="{DynamicResource CardStyle}" Margin="16,0,0,0">
                                    <StackPanel>
                                        <TextBlock Text="实时预览"
                                                   FontFamily="{DynamicResource UIFont}"
                                                   FontSize="16"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   Margin="0,0,0,14"/>

                                        <Border Background="{DynamicResource BackgroundBrush}"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="10"
                                                Padding="12">
                                            <StackPanel>
                                                <TextBlock Text="当前主题" Style="{StaticResource SettingsLabelStyle}"/>
                                                <TextBlock Text="{Binding Theme, Converter={StaticResource ConfigEnumDisplayConverter}}"
                                                           FontFamily="{DynamicResource UIFont}"
                                                           FontSize="15"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           Margin="0,6,0,0"/>

                                                <Border Height="10"
                                                        CornerRadius="999"
                                                        Margin="0,12,0,0"
                                                        Background="{DynamicResource PrimaryGradientBrush}"/>
                                            </StackPanel>
                                        </Border>

                                        <TextBlock Text="视频摘要" Style="{StaticResource SettingsLabelStyle}" Margin="0,16,0,0"/>
                                        <TextBlock Text="{Binding VideoSummary}"
                                                   FontFamily="{DynamicResource MonoFont}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   Margin="0,6,0,0"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="视频">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Grid Margin="0,16,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="260"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" Style="{DynamicResource CardStyle}">
                                    <StackPanel>
                                        <TextBlock Text="视频配置"
                                                   FontFamily="{DynamicResource UIFont}"
                                                   FontSize="16"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   Margin="0,0,0,14"/>

                                        <TextBlock Text="分辨率" Style="{StaticResource SettingsLabelStyle}"/>
                                        <ComboBox Style="{StaticResource SettingsComboBoxStyle}"
                                                  ItemsSource="{Binding ResolutionOptions}"
                                                  SelectedItem="{Binding Resolution}"
                                                  DisplayMemberPath="DisplayName"/>

                                        <TextBlock Text="帧率（fps）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                        <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                                 Text="{Binding FrameRate, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>

                                        <TextBlock Text="码率（Mbps）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                        <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                                 Text="{Binding BitrateMbps, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>

                                        <TextBlock Text="编码器" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                        <ComboBox Style="{StaticResource SettingsComboBoxStyle}"
                                                  ItemsSource="{Binding EncoderOptions}"
                                                  SelectedItem="{Binding Encoder}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource ConfigEnumDisplayConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>

                                        <TextBlock Text="提示：硬件编码需要设备驱动与 FFmpeg 支持。"
                                                   Style="{StaticResource SettingsLabelStyle}"
                                                   Margin="0,10,0,0"/>
                                    </StackPanel>
                                </Border>

                                <Border Grid.Column="1" Style="{DynamicResource CardStyle}" Margin="16,0,0,0">
                                    <StackPanel>
                                        <TextBlock Text="预览"
                                                   FontFamily="{DynamicResource UIFont}"
                                                   FontSize="16"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   Margin="0,0,0,14"/>

                                        <Border Background="{DynamicResource BackgroundBrush}"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="10"
                                                Padding="12">
                                            <StackPanel>
                                                <TextBlock Text="当前组合" Style="{StaticResource SettingsLabelStyle}"/>
                                                <TextBlock Text="{Binding VideoSummary}"
                                                           FontFamily="{DynamicResource MonoFont}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           Margin="0,6,0,0"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="音频">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Border Style="{DynamicResource CardStyle}" Margin="0,16,0,0">
                                <StackPanel>
                                    <TextBlock Text="音频传输"
                                               FontFamily="{DynamicResource UIFont}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               Margin="0,0,0,14"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="180"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="启用音频" Style="{StaticResource SettingsLabelStyle}" VerticalAlignment="Center"/>
                                        <CheckBox Grid.Row="0" Grid.Column="1" VerticalAlignment="Center" IsChecked="{Binding AudioEnabled}"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="编码格式" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0" VerticalAlignment="Center"/>
                                        <ComboBox Grid.Row="1" Grid.Column="1"
                                                  Style="{StaticResource SettingsComboBoxStyle}"
                                                  ItemsSource="{Binding AudioCodecOptions}"
                                                  SelectedItem="{Binding AudioCodec}"
                                                  Margin="0,14,0,0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource ConfigEnumDisplayConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="码率（kbps）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0" VerticalAlignment="Center"/>
                                        <TextBox Grid.Row="2" Grid.Column="1"
                                                 Style="{StaticResource SettingsTextBoxStyle}"
                                                 Text="{Binding AudioBitrateKbps, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"
                                                 Margin="0,14,0,0"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="帧时长（ms）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0" VerticalAlignment="Center"/>
                                        <TextBox Grid.Row="3" Grid.Column="1"
                                                 Style="{StaticResource SettingsTextBoxStyle}"
                                                 Text="{Binding AudioFrameDurationMs, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"
                                                 Margin="0,14,0,0"/>

                                        <TextBlock Grid.Row="4" Grid.Column="0" Text="当前配置" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0" VerticalAlignment="Center"/>
                                        <TextBlock Grid.Row="4" Grid.Column="1"
                                                   Text="{Binding AudioSummary}"
                                                   FontFamily="{DynamicResource MonoFont}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   Margin="0,14,0,0"/>
                                    </Grid>

                                    <TextBlock Text="提示：开启音频会额外占用带宽；需接收端实现音频解码与播放。"
                                               Style="{StaticResource SettingsLabelStyle}"
                                               Margin="0,14,0,0"/>
                                </StackPanel>
                            </Border>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="网络">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Border Style="{DynamicResource CardStyle}" Margin="0,16,0,0">
                                <StackPanel>
                                    <TextBlock Text="网络配置"
                                               FontFamily="{DynamicResource UIFont}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               Margin="0,0,0,14"/>

                                    <TextBlock Text="TCP 端口" Style="{StaticResource SettingsLabelStyle}"/>
                                    <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                             Text="{Binding TcpPort, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>

                                    <TextBlock Text="超时（秒）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                             Text="{Binding TimeoutSeconds, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>

                                    <TextBlock Text="重连次数" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                             Text="{Binding ReconnectAttempts, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>

                                    <TextBlock Text="重连间隔（ms）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                             Text="{Binding ReconnectDelayMs, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>

                                    <TextBlock Text="修改端口可能需要重启连接服务后生效。"
                                               Style="{StaticResource SettingsLabelStyle}"
                                               Margin="0,10,0,0"/>

                                    <Border Background="{DynamicResource BackgroundBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="12"
                                            Padding="18"
                                            Margin="0,18,0,0">
                                        <StackPanel>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel>
                                                    <TextBlock Text="启用 WiFi TLS 加密" Style="{StaticResource SettingsValueStyle}"/>
                                                    <TextBlock Text="启用后 Android 端需要输入配对码完成首次信任。"
                                                               Style="{StaticResource SettingsLabelStyle}"
                                                               Margin="0,4,0,0"/>
                                                </StackPanel>

                                                <CheckBox Grid.Column="1"
                                                          VerticalAlignment="Center"
                                                          IsChecked="{Binding EnableTls}"/>
                                            </Grid>

                                            <Grid Margin="0,14,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel>
                                                    <TextBlock Text="配对码（6位）" Style="{StaticResource SettingsLabelStyle}"/>
                                                    <TextBlock Text="{Binding WifiTlsPairingCode}"
                                                               FontFamily="{DynamicResource MonoFont}"
                                                               FontSize="26"
                                                               FontWeight="SemiBold"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                                               Margin="0,4,0,0"/>
                                                    <TextBlock Text="{Binding WifiTlsFingerprintSha256}"
                                                               FontFamily="{DynamicResource MonoFont}"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource TextDisabledBrush}"
                                                               TextWrapping="Wrap"
                                                               Margin="0,6,0,0"/>
                                                </StackPanel>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}"
                                                            Content="复制"
                                                            Padding="12,6"
                                                            Margin="0,0,10,0"
                                                            Click="CopyPairingCode_Click"/>
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}"
                                                            Content="重置配对"
                                                            Padding="12,6"
                                                            Click="RotateTlsCertificate_Click"/>
                                                </StackPanel>
                                            </Grid>

                                            <TextBlock Text="重置配对会重新生成证书并变更配对码；Android 端需删除旧信任后重新配对。"
                                                       Style="{StaticResource SettingsLabelStyle}"
                                                       Margin="0,12,0,0"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="性能">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Border Style="{DynamicResource CardStyle}" Margin="0,16,0,0">
                                <StackPanel>
                                    <TextBlock Text="性能配置"
                                               FontFamily="{DynamicResource UIFont}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               Margin="0,0,0,14"/>

                                    <TextBlock Text="性能模式" Style="{StaticResource SettingsLabelStyle}"/>
                                    <ComboBox Style="{StaticResource SettingsComboBoxStyle}"
                                              ItemsSource="{Binding PerformanceModeOptions}"
                                              SelectedItem="{Binding PerformanceMode}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource ConfigEnumDisplayConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>

                                    <TextBlock Text="编码线程数（0 自动）" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                             Text="{Binding EncodingThreadCount, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}"/>
                                </StackPanel>
                            </Border>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="快捷键">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Border Style="{DynamicResource CardStyle}" Margin="0,16,0,0">
                                <StackPanel>
                                    <TextBlock Text="全局快捷键"
                                               FontFamily="{DynamicResource UIFont}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               Margin="0,0,0,8"/>

                                    <TextBlock Text="即使主窗口隐藏到托盘也可触发；若注册失败，通常是被系统或其他软件占用。"
                                               Style="{StaticResource SettingsLabelStyle}"
                                               Margin="0,0,0,18"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel>
                                            <TextBlock Text="启用全局快捷键" Style="{StaticResource SettingsValueStyle}"/>
                                            <TextBlock Text="关闭后将不注册 RegisterHotKey。"
                                                       Style="{StaticResource SettingsLabelStyle}"
                                                       Margin="0,4,0,0"/>
                                        </StackPanel>

                                        <CheckBox Grid.Column="1"
                                                  VerticalAlignment="Center"
                                                  IsChecked="{Binding HotkeysEnabled}"/>
                                    </Grid>

                                    <Border Background="{DynamicResource BackgroundBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="12"
                                            Padding="18"
                                            Margin="0,20,0,0">
                                        <StackPanel>
                                            <DockPanel Margin="0,0,0,10">
                                                <TextBlock Text="快捷键列表"
                                                           FontFamily="{DynamicResource UIFont}"
                                                           FontSize="14"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           VerticalAlignment="Center"/>
                                                <Button DockPanel.Dock="Right"
                                                        Style="{DynamicResource SecondaryButtonStyle}"
                                                        Content="恢复默认快捷键"
                                                        Padding="12,6"
                                                        Click="RestoreHotkeys_Click"/>
                                            </DockPanel>

                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="280"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="显示/隐藏主窗口" Style="{StaticResource SettingsLabelStyle}" VerticalAlignment="Center"/>
                                                <TextBox Grid.Row="0" Grid.Column="1" Style="{StaticResource SettingsTextBoxStyle}" Margin="0,0,12,0"
                                                         IsReadOnly="True"
                                                         Text="{Binding HotkeyToggleMainWindow}"/>
                                                <StackPanel Grid.Row="0" Grid.Column="2" Orientation="Horizontal">
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="录制" Padding="10,6" Margin="0,0,8,0" Tag="ToggleMainWindow" Click="RecordHotkey_Click"/>
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="清除" Padding="10,6" Tag="ToggleMainWindow" Click="ClearHotkey_Click"/>
                                                </StackPanel>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="连接/断开（当前设备）" Style="{StaticResource SettingsLabelStyle}" Margin="0,12,0,0" VerticalAlignment="Center"/>
                                                <TextBox Grid.Row="1" Grid.Column="1" Style="{StaticResource SettingsTextBoxStyle}" Margin="0,12,12,0"
                                                         IsReadOnly="True"
                                                         Text="{Binding HotkeyConnectDisconnect}"/>
                                                <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Margin="0,12,0,0">
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="录制" Padding="10,6" Margin="0,0,8,0" Tag="ConnectDisconnect" Click="RecordHotkey_Click"/>
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="清除" Padding="10,6" Tag="ConnectDisconnect" Click="ClearHotkey_Click"/>
                                                </StackPanel>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="切换设备（下一个）" Style="{StaticResource SettingsLabelStyle}" Margin="0,12,0,0" VerticalAlignment="Center"/>
                                                <TextBox Grid.Row="2" Grid.Column="1" Style="{StaticResource SettingsTextBoxStyle}" Margin="0,12,12,0"
                                                         IsReadOnly="True"
                                                         Text="{Binding HotkeyNextDevice}"/>
                                                <StackPanel Grid.Row="2" Grid.Column="2" Orientation="Horizontal" Margin="0,12,0,0">
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="录制" Padding="10,6" Margin="0,0,8,0" Tag="NextDevice" Click="RecordHotkey_Click"/>
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="清除" Padding="10,6" Tag="NextDevice" Click="ClearHotkey_Click"/>
                                                </StackPanel>

                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="切换性能模式" Style="{StaticResource SettingsLabelStyle}" Margin="0,12,0,0" VerticalAlignment="Center"/>
                                                <TextBox Grid.Row="3" Grid.Column="1" Style="{StaticResource SettingsTextBoxStyle}" Margin="0,12,12,0"
                                                         IsReadOnly="True"
                                                         Text="{Binding HotkeyTogglePerformanceMode}"/>
                                                <StackPanel Grid.Row="3" Grid.Column="2" Orientation="Horizontal" Margin="0,12,0,0">
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="录制" Padding="10,6" Margin="0,0,8,0" Tag="TogglePerformanceMode" Click="RecordHotkey_Click"/>
                                                    <Button Style="{DynamicResource SecondaryButtonStyle}" Content="清除" Padding="10,6" Tag="TogglePerformanceMode" Click="ClearHotkey_Click"/>
                                                </StackPanel>
                                            </Grid>

                                            <TextBlock Text="提示：建议至少包含一个修饰键（Ctrl/Alt/Shift），避免误触。"
                                                       Style="{StaticResource SettingsLabelStyle}"
                                                       Margin="0,14,0,0"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="关于">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Border Style="{DynamicResource CardStyle}" Margin="0,16,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="140"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="版本" Style="{StaticResource SettingsLabelStyle}" Margin="0,0,0,10"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{x:Static svc:AppInfo.DisplayVersion}"
                                               FontFamily="{DynamicResource MonoFont}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="配置文件" Style="{StaticResource SettingsLabelStyle}"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ConfigPath}"
                                               FontFamily="{DynamicResource MonoFont}" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" TextWrapping="Wrap"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="更新" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="0,14,0,0">
                                        <Button Style="{DynamicResource SecondaryButtonStyle}"
                                                Content="检查更新"
                                                Padding="14,6"
                                                Click="CheckUpdates_Click"
                                                Margin="0,0,12,0"/>
                                        <TextBlock Text="（优先）EXPANDSCREEN_UPDATE_MANIFEST"
                                                   Style="{StaticResource SettingsLabelStyle}"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="更新源" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <StackPanel Grid.Row="3" Grid.Column="1" Margin="0,14,0,0">
                                        <CheckBox IsChecked="{Binding UpdateEnabled}"
                                                  FontFamily="{DynamicResource UIFont}"
                                                  FontSize="13"
                                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                                  Content="启用自动更新（检查更新时使用以下清单）"
                                                  Margin="0,0,0,10"/>
                                        <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                                 Text="{Binding UpdateManifestUri, UpdateSourceTrigger=PropertyChanged}"
                                                 ToolTip="支持 https://... 或本地路径 C:\\path\\latest.json"/>
                                        <TextBlock Text="支持 URL 或本地文件路径；环境变量存在时会覆盖此处配置。"
                                                   Style="{StaticResource SettingsLabelStyle}"
                                                   Margin="0,8,0,0"
                                                   TextWrapping="Wrap"/>
                                    </StackPanel>

                                    <TextBlock Grid.Row="4" Grid.Column="0" Text="签名验证" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <StackPanel Grid.Row="4" Grid.Column="1" Margin="0,14,0,0">
                                        <CheckBox IsChecked="{Binding UpdateRequireManifestSignature}"
                                                  FontFamily="{DynamicResource UIFont}"
                                                  FontSize="13"
                                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                                  Content="强制清单签名验证（RSA）"/>
                                        <TextBox Style="{StaticResource SettingsTextBoxStyle}"
                                                 Text="{Binding UpdateTrustedManifestPublicKeyPem, UpdateSourceTrigger=PropertyChanged}"
                                                 Visibility="{Binding UpdateRequireManifestSignature, Converter={StaticResource BoolToVisibilityConverter}}"
                                                 AcceptsReturn="True"
                                                 TextWrapping="Wrap"
                                                 VerticalScrollBarVisibility="Auto"
                                                 MinHeight="110"
                                                 ToolTip="粘贴 PEM 格式公钥（BEGIN PUBLIC KEY/BEGIN RSA PUBLIC KEY）"/>
                                        <TextBlock Text="启用后需提供可信公钥 PEM；否则保存时会自动关闭该选项。"
                                                   Style="{StaticResource SettingsLabelStyle}"
                                                   Margin="0,8,0,0"
                                                   TextWrapping="Wrap"/>
                                    </StackPanel>

                                    <TextBlock Grid.Row="5" Grid.Column="0" Text="项目" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <TextBlock Grid.Row="5" Grid.Column="1" Margin="0,14,0,0"
                                               FontFamily="{DynamicResource UIFont}" FontSize="14" Foreground="{DynamicResource PrimaryBrush}">
                                        <Hyperlink NavigateUri="https://github.com/expandscreen"
                                                   Foreground="{DynamicResource PrimaryBrush}"
                                                   TextDecorations="None">
                                            ExpandScreen on GitHub
                                        </Hyperlink>
                                    </TextBlock>

                                    <TextBlock Grid.Row="6" Grid.Column="0" Text="诊断" Style="{StaticResource SettingsLabelStyle}" Margin="0,14,0,0"/>
                                    <StackPanel Grid.Row="6" Grid.Column="1" Orientation="Horizontal" Margin="0,14,0,0">
                                        <Button Style="{DynamicResource SecondaryButtonStyle}"
                                                Content="打开日志目录"
                                                Padding="14,6"
                                                Click="OpenLogDirectory_Click"
                                                Margin="0,0,12,0"/>
                                        <Button Style="{DynamicResource SecondaryButtonStyle}"
                                                Content="导出诊断包"
                                                Padding="14,6"
                                                Click="ExportDiagnostics_Click"
                                                Margin="0,0,12,0"/>
                                        <Button Style="{DynamicResource SecondaryButtonStyle}"
                                                Content="复制兼容性摘要"
                                                Padding="14,6"
                                                Click="CopyCompatibilitySummary_Click"
                                                Margin="0,0,12,0"/>
                                        <TextBlock Text="（包含系统信息/兼容性/配置/日志/性能快照）"
                                                   Style="{StaticResource SettingsLabelStyle}"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </ScrollViewer>
                    </TabItem>

                </TabControl>
            </Grid>

            <!-- Button Bar -->
            <Border Grid.Row="2"
                    Background="{DynamicResource SurfaceBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,1,0,0"
                    CornerRadius="0,0,12,12"
                    Padding="24,16">
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <Button Style="{DynamicResource SecondaryButtonStyle}"
                            Content="取消"
                            Margin="0,0,12,0"
                            Click="CancelButton_Click"/>
                    <Button Style="{DynamicResource SecondaryButtonStyle}"
                            Content="恢复默认"
                            Margin="0,0,12,0"
                            Click="RestoreDefaults_Click"/>
                    <Button Style="{DynamicResource PrimaryButtonStyle}"
                            Content="保存设置"
                            Click="SaveSettings_Click"/>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</Window>
