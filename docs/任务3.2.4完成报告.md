# 任务3.2.4 完成报告：设置功能（AND-104）

- **任务ID**: AND-104
- **优先级**: P1
- **负责人**: Android工程师1
- **完成日期**: 2026-01-24
- **分支**: vk/ab4f-3-2-4

## 目标

为 Android 客户端补齐“设置功能”闭环：提供可配置的设置界面、统一配置存储与数据流、关键选项可在运行时实时生效，并支持导入/导出配置以便联调与复现问题。

## 实现内容

### 1) 设置界面（Jetpack Preference）

- 新增 `SettingsActivity` + `SettingsFragment`（PreferenceFragmentCompat）：
  - 视频：分辨率 / 帧率 / 画质（先作为“请求/偏好”保存，为后续与 Windows 编码/协商对接预留）
  - 性能：性能预设（省电/平衡/性能）+ 低延迟模式开关
  - 显示：常亮 / 旋转 / 全屏
  - 网络：首选连接方式 / 自动重连
  - 关于：版本信息 + 开源许可入口

### 2) SettingsRepository（SharedPreferences + Flow）

- 新增 `SettingsRepository`：
  - 使用 SharedPreferences（`expandscreen_settings`）作为持久化层
  - 通过 `SharedPreferences.OnSharedPreferenceChangeListener` 驱动 `StateFlow<AppSettings>`，形成统一“设置数据流”
  - 支持 JSON 导入/导出（kotlinx.serialization）

### 3) 设置实时生效

- `DisplayService`：
  - 订阅性能预设（映射到 `PerformanceMode`），在运行时动态应用
  - 订阅低延迟开关，触发 decoder flush + 在下一帧到来时用新参数重建解码器
- `DisplayActivity`：
  - 订阅常亮/旋转/全屏设置并实时应用（Window flags / system bars / orientation）
  - 菜单内的“旋转锁/性能模式”操作反向写回到 `SettingsRepository`，确保持久化一致

### 4) 配置导入/导出

- 设置页提供“导入/导出配置”入口：
  - 导出：通过 SAF 选择目标文件，写入 JSON
  - 导入：通过 SAF 选择 JSON 文件，解析后写入 SharedPreferences 并触发全局实时更新

## 构建与测试

- 关键构建/测试命令与结果见：`build-test-notes.txt`（追加 AND-104 记录）

## 关键文件

- `android-client/app/src/main/kotlin/com/expandscreen/data/repository/AppSettings.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/repository/SettingsRepository.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/repository/SharedPreferencesSettingsRepository.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/di/SettingsModule.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/settings/SettingsActivity.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/settings/SettingsFragment.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/settings/OpenSourceLicensesActivity.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/MainScreen.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/MainRoute.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/MainViewModel.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/DisplayActivity.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/service/DisplayService.kt`

