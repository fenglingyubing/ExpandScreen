# 任务3.2.3 完成报告：性能优化（AND-103）

- **任务ID**: AND-103
- **优先级**: P1
- **负责人**: Android工程师1 + Android工程师2
- **完成日期**: 2026-01-24
- **分支**: vk/9d70-3-2-3

## 目标

围绕 Android 客户端的端到端体验做性能优化：降低不必要的内存分配与拷贝、提供可控的性能/省电模式、减少触控上报负载，并保持现有 HUD 可观测性与联调效率。

## 实现内容

### 1) 网络发送路径：减少分配与拷贝

- 新增 `MessageCodec.encodeHeaderInto(...)` 与 `MessageCodec.writeMessage(...)`：
  - Header 使用固定 24B scratch 复用写入（Big Endian）
  - 发送时直接 `OutputStream.write(header)` + `write(payload)`，避免每次拼接生成“头+负载”大数组
- `NetworkManager`：
  - `sendJsonMessageToOutput(...)` 与 `sendTouchEvents(...)` 复用 Header scratch，并通过 `writeMessage` 写入
  - `receiveLoop(...)` 复用 Header scratch（`readHeader(input, scratch)`），减少小对象分配

### 2) 省电/平衡/性能模式：解码与上报节奏可控

- 新增 `PerformanceMode`：
  - `targetRenderFps`：目标帧率上限（省电/平衡/性能）
  - `decoderOperatingRateFps`：MediaCodec operating-rate（best-effort）
  - `lowLatency`：低延迟解码开关（省电模式关闭以降低功耗）
  - `touchMinMoveIntervalMs`：触控 Move 事件节流阈值
- `DisplayService`：
  - 省电模式下按 `targetRenderFps` 丢弃超出节奏的非关键帧，降低解码/渲染负载
  - 模式切换后触发 decoder flush + 重新初始化（在下一帧到来时应用新配置）
- `TouchProcessor`：
  - `minMoveIntervalMs` 改为 provider，支持随模式动态调整 Move 事件节流阈值

### 3) UI 控制：在显示页菜单提供模式切换入口

- `DisplayActivity` 菜单新增 “PERF / BAL / SAVE” 模式切换 Chip：
  - 省电模式下将 Activity 屏幕亮度调低到 0.6（退出省电模式后恢复系统默认）
  - Mode 信息以 monospace 提示（当前模式、触控节流阈值、帧率上限）

## 构建与测试

1. Android（assemble + 单元测试）:
   - `pushd android-client; $env:JAVA_HOME="F:\\Java\\jdk-21"; $env:Path="$env:JAVA_HOME\\bin;$env:Path"; .\\gradlew.bat :app:assembleDebug :app:testDebugUnitTest --no-daemon; popd`
   - 结果：`BUILD SUCCESSFUL`（48 actionable tasks, 1m 43s）
2. .NET（解决方案测试）:
   - `dotnet test ExpandScreen.sln -c Release`
   - 结果：Passed 21, Skipped 9, Failed 0

## 关键文件

- `android-client/app/src/main/kotlin/com/expandscreen/core/performance/PerformanceMode.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/core/input/TouchProcessor.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/protocol/Messages.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/core/network/NetworkManager.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/service/DisplayService.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/service/DisplayServiceState.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/DisplayActivity.kt`

