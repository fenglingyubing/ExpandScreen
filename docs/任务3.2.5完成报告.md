# 任务3.2.5 完成报告：数据持久化（AND-105）

- **任务ID**: AND-105
- **优先级**: P2
- **负责人**: Android工程师1
- **完成日期**: 2026-01-24
- **分支**: vk/2f8a-3-2-5

## 目标

为 Android 客户端补齐数据持久化能力：使用 Room 存储历史 Windows 设备（含收藏）与连接日志（含统计），并通过 Repository 提供统一的数据访问入口；连接过程自动写入日志，后续可用于历史回连与性能统计展示。

## 实现内容

### 1) Room 数据库设计

- `windows_devices`：`WindowsDeviceEntity`（设备名、IP、最近连接时间、收藏、连接方式）
- `connection_logs`：`ConnectionLogEntity`（设备ID、会话起止时间、持续时长、平均 FPS/延迟、连接方式）
- DAO：
  - `DeviceDao`：历史/收藏查询、按 IP/名称查找、更新 lastConnected
  - `ConnectionLogDao`：最近日志/按设备查询、写入/更新、平均 FPS/延迟统计
- Database：`ExpandScreenDatabase`（version=1）

### 2) Repository 模式

- `DeviceRepository`：
  - `upsertConnectedDevice(...)`：按 IP/类型（或名称/类型）查找并更新，统一沉淀历史设备
  - `toggleFavorite(...)`：收藏切换
- `ConnectionLogRepository`：
  - `startLog(...) / endLog(...)`：记录连接会话（含 duration 与平均指标）
  - `getAverageFps(...) / getAverageLatencyMs(...)`：统计接口（供后续 UI 使用）

### 3) 自动记录连接日志

- `DisplayService` 在连接状态变更时：
  - 连接建立：创建日志（startTime）
  - 连接断开/停止：结束日志（endTime/duration），并按 1s 采样计算平均 FPS/延迟写入
- `MainViewModel` → `DisplayActivity`：在进入显示页时携带当前设备ID与连接方式，供 `DisplayService` 关联日志

### 4) 数据库迁移策略

- 新增 `ExpandScreenDatabaseMigrations` 作为统一 migration 入口
- Builder 配置：
  - 升级：要求显式 migrations（未提供则按 Room 行为失败，避免静默丢数据）
  - 降级：允许 destructive（开发期兜底）

## 构建与测试

- 关键构建/测试命令与结果见：`build-test-notes.txt`（追加 AND-105 记录）

## 关键文件

- `android-client/app/src/main/kotlin/com/expandscreen/data/model/Entities.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/database/Daos.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/database/ExpandScreenDatabase.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/database/ExpandScreenDatabaseMigrations.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/di/DatabaseModule.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/repository/DeviceRepository.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/data/repository/ConnectionLogRepository.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/service/DisplayService.kt`
- `android-client/app/src/test/kotlin/com/expandscreen/data/database/ExpandScreenDatabaseTest.kt`

