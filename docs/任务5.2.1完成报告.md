# 任务5.2.1 完成报告：性能优化（OPT-001）

## 任务信息

- **任务ID**：OPT-001
- **优先级**：P0
- **负责人**：Windows工程师2 + Android工程师2
- **完成日期**：2026-01-26

## 交付目标

基于 TEST-002 的采样工具与联调链路，落地一批“可验证、低风险”的性能优化，覆盖：

- **延迟/卡顿**：减少 UI 线程重活，避免采样窗口自身成为干扰项
- **CPU**：消除可见热点（重复拷贝/重复分配/重复遍历）
- **内存**：降低长时间录制与导出时的峰值分配与 GC 压力
- **网络**：减少视频帧链路中的不必要拷贝

## 完成内容（摘要）

### 1) WiFi/协议：VideoFrame 缓冲避免二次拷贝

- `NetworkSession.BufferVideoFrame(...)` 不再为每个 `VideoFrame` 再额外复制一份 payload。
- 直接复用 `NetworkReceiver` 为该消息创建的 payload 缓冲区引用，减少一次 `Buffer.BlockCopy` 与一次同尺寸分配。

收益：在高帧率/大分辨率下显著降低 CPU 与内存带宽占用，并缩短关键路径处理时间。

### 2) Windows UI：性能测试采样后台化 + Sparkline 低分配更新

- 将采样从 `DispatcherTimer`（UI 线程）迁移到后台 `PeriodicTimer` 循环；UI 仅做轻量的属性更新与绘制数据更新。
- CPU/内存历史改为固定大小 **ring buffer**，避免 `RemoveAt(0)` 造成的频繁搬移。
- Sparkline 改为复用同一份 `PointCollection`，每次 tick 原地 `Clear()+Add(...)`，避免每 500ms 分配新集合导致的 UI 垃圾与抖动。

### 3) 导出与汇总：CSV 流式写入 + 单次遍历统计

- `ExportCsvAsync` 改为 `StreamWriter` 流式写入，避免长录制时构建超大 `StringBuilder` 引起内存峰值与导出延迟。
- `BuildQuickSummary` 改为单次遍历计算 avg/max，减少多次 LINQ 遍历开销。

## 关键输出文件

- `src/ExpandScreen.Protocol/Network/NetworkSession.cs`
- `src/ExpandScreen.Services/Diagnostics/PerformanceSampleSeries.cs`
- `src/ExpandScreen.UI/ViewModels/PerformanceTestViewModel.cs`
- `docs/开发流程文档.md`（新增 5.2.1 节）

## 验证建议（最小执行清单）

1. Windows 客户端打开 `⏱ 性能测试`，空闲录制 1 分钟 → 导出 CSV（确认导出速度与内存占用更平稳）。
2. 运行 1080p@60 或更高负载场景录制 3 分钟 → 观察 UI 是否更少卡顿（采样窗口不应成为瓶颈）。
3. WiFi 视频帧链路联调场景下，对比优化前后 CPU/WorkingSet 曲线（重点关注 GC 与瞬时峰值）。

