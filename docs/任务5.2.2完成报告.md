# 任务5.2.2 完成报告：稳定性优化（OPT-002）

## 任务信息

- **任务ID**：OPT-002
- **优先级**：P0
- **负责人**：全员
- **完成日期**：2026-01-26

## 交付目标

围绕“崩溃/异常/资源释放/日志”四条主线做稳定性加固，让应用在：

- 连接异常、后台任务异常、退出清理等场景下 **不因二次异常导致崩溃**
- 出错时能提供 **用户友好提示**，并可一键 **复制详情** 便于反馈
- 关键链路的异常能够 **落盘日志** 以便复现与排查

## 完成内容（摘要）

### 1) Bug 修复：清理阶段 best-effort，避免“Dispose 崩溃”

- `NetworkReceiver/NetworkSender/NetworkSession` 的 `Dispose()` 增加防御式处理：
  - `Cancel/Wait/Dispose` 全部包裹异常处理
  - 后台任务 fault 时不再在清理阶段二次抛出导致进程退出

### 2) 异常处理完善：全局未处理异常捕获 + 友好提示

- Windows UI 启动时注册：
  - `DispatcherUnhandledException`（UI 线程未处理异常）
  - `AppDomain.CurrentDomain.UnhandledException`（进程级未处理异常）
  - `TaskScheduler.UnobservedTaskException`（未观察的后台任务异常）
- UI 异常时弹出统一异常对话框（可复制详情，支持“继续/退出”），并记录到日志目录。

### 3) 资源管理优化：编码服务停止/释放更健壮

- `VideoEncodingService.StopAsync()` 在取消/等待编码线程时做防御式处理，避免 stop/exit 阶段异常扩散。
- `VideoEncodingService.Dispose()` 改为 best-effort，停止失败也不会影响后续资源释放。

### 4) 日志完善：关键异常路径落盘

- 上述稳定性增强点均通过 `LogHelper` 输出关键异常信息，方便定位“哪个清理阶段/哪个后台任务”导致的问题。

## 关键输出文件

- `src/ExpandScreen.UI/App.xaml.cs`
- `src/ExpandScreen.UI/Views/UnhandledExceptionDialog.xaml`
- `src/ExpandScreen.UI/Views/UnhandledExceptionDialog.xaml.cs`
- `src/ExpandScreen.Protocol/Network/NetworkSession.cs`
- `src/ExpandScreen.Protocol/Network/NetworkReceiver.cs`
- `src/ExpandScreen.Protocol/Network/NetworkSender.cs`
- `src/ExpandScreen.Core/Encode/VideoEncodingService.cs`
- `src/ExpandScreen.Services/Diagnostics/PerformanceSampleSeries.cs`

## 验证与测试

构建/测试（Windows）：

- SDK：8.0.417
- 构建：`dotnet build ExpandScreen.sln -c Release`
  - 结果：成功（0 警告，0 错误）
- 测试：`dotnet test ExpandScreen.sln -c Release --no-build`
  - 结果：通过 48，跳过 9，失败 0（总计 57）

说明：
- 测试集中部分端到端/编码器测试在无外部依赖环境下会标记为 SKIP（既有行为），不影响本任务回归结论。
