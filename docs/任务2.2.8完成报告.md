# 任务2.2.8 完成报告：Android 集成测试和调试（AND-008）

## 任务信息
- **任务ID**: AND-008
- **优先级**: P0
- **范围**: 模块集成（网络接收→解码→渲染、UI→Service→Core）、端到端联调自检、性能指标采集、问题定位与修复
- **完成日期**: 2026-01-23

## 完成内容

### 1) 集成自检用例（协议/网络端到端）
基于本地 `ServerSocket` 的端到端单元测试，覆盖 Android 客户端核心协议链路：
- 握手流程：连接→发送 Handshake→接收 HandshakeAck（已有用例）
- Heartbeat 双向：
  - 服务端 Heartbeat → 客户端回 HeartbeatAck
  - 客户端定时发送 Heartbeat（间隔参数化，避免测试过慢/易抖动）
- VideoFrame 下行：服务端发送 VideoFrame → 客户端 `incomingMessages` 正确发布

对应新增/调整：
- `android-client/app/src/main/kotlin/com/expandscreen/core/network/NetworkManager.kt`（新增 `NetworkManagerConfig`，便于测试缩短心跳间隔）
- `android-client/app/src/test/kotlin/com/expandscreen/core/network/NetworkManagerHeartbeatAckTest.kt`
- `android-client/app/src/test/kotlin/com/expandscreen/core/network/NetworkManagerClientHeartbeatTest.kt`
- `android-client/app/src/test/kotlin/com/expandscreen/core/network/NetworkManagerVideoFrameTest.kt`

### 2) 性能与诊断指标（Service/HUD）
为联调期“是否在收流/是否在丢帧/是否需要关键帧/是否频繁重置解码器”等问题提供可视化指标：
- `DisplayServiceState` 新增：
  - **PSS 内存（MB）**、**CPU 使用率（%）**
  - 解码队列长度、丢帧计数、关键帧门控跳过计数、解码器重置/重配计数
- `DisplayService` 增加每秒采样的 metrics loop，并更新前台通知与 HUD 的状态来源
- `DisplayActivity` HUD/菜单展示上述诊断信息，便于现场定位

对应新增/调整：
- `android-client/app/src/main/kotlin/com/expandscreen/core/decoder/VideoDecoder.kt`（`H264Decoder.snapshotStats()`）
- `android-client/app/src/main/kotlin/com/expandscreen/service/DisplayService.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/service/DisplayServiceState.kt`
- `android-client/app/src/main/kotlin/com/expandscreen/ui/DisplayActivity.kt`

## 构建/测试命令（Android）
在 `android-client/` 目录下：
- `./gradlew :app:assembleDebug`
- `./gradlew :app:testDebugUnitTest`

## 联调建议（Windows ↔ Android）
- 建议先观察 HUD 指标是否变化（FPS/Latency/Decoder Queue），再进一步定位：
  - `KF`（跳过非关键帧）持续增加：说明服务端未先送 I-Frame / 或关键帧间隔过长
  - `DROP` 持续增加：说明下行帧到达速度 > 解码处理能力（需降码率/降帧率/优化队列策略）
  - `RST/CFG` 频繁增长：说明 MediaCodec 异常或分辨率频繁变更

