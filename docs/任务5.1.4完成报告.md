# 任务5.1.4 完成报告：安全测试（TEST-004）

## 任务信息

- **任务ID**：TEST-004
- **优先级**：P1
- **负责人**：测试工程师 + 全栈工程师
- **完成日期**：2026-01-25

## 交付目标

为“安全测试”提供一个可执行的最小闭环，覆盖：

- 认证：未配对设备拒绝连接、配对码错误处理
- 加密：TLS 传输加密与证书固定（pinned certificate）验证辅助信息留存
- 权限：Windows 防火墙规则与管理员权限相关信息可见
- 数据保护：本地 TLS 证书（DPAPI）与日志/配置路径可追溯

## 完成内容（摘要）

### 1) 认证：TLS 模式下增加配对码握手校验

- `HandshakeMessage` 增加可选字段 `PairingCode`
- Windows 端 `WifiConnection` 在启用 TLS 时要求客户端在握手中提供正确配对码，否则拒绝握手并返回错误信息
- 新增集成测试覆盖“错误配对码应被拒绝”的路径

> 说明：配对码为 6 位数字，由当前 WiFi TLS 证书的 SHA-256 指纹派生；在 `设置` 中可查看与复制。

### 2) 重放攻击防护：严格校验消息序列号单调递增

- `NetworkReceiver` 在 TCP 链路上检测到非递增 `SequenceNumber` 时，视为异常数据并终止接收（避免重复/重放导致的状态回退）

### 3) 安全测试留存：导出“安全快照”并支持一键复制摘要

- 诊断包导出新增：
  - `security-info.json`：TLS/防火墙（best-effort）/路径等安全相关信息
  - `security-summary.txt`：便于粘贴到缺陷单/测试记录的摘要
- 设置页 `设置 → 诊断` 新增按钮：`复制安全摘要`

> 说明：`security-summary.txt` 中的配对码默认做掩码处理；需要完整配对码时从设置页复制即可。

## 关键输出文件

- `src/ExpandScreen.Services/Diagnostics/SecuritySnapshot.cs`
- `src/ExpandScreen.Services/Diagnostics/SecuritySnapshotCollector.cs`
- `src/ExpandScreen.Services/Diagnostics/DiagnosticsExportService.cs`
- `src/ExpandScreen.Protocol/Messages/ProtocolMessages.cs`
- `src/ExpandScreen.Services/Connection/WifiConnection.cs`
- `src/ExpandScreen.Protocol/Network/NetworkReceiver.cs`
- `src/ExpandScreen.UI/Views/SettingsWindow.xaml`
- `src/ExpandScreen.UI/Views/SettingsWindow.xaml.cs`
- `src/ExpandScreen.IntegrationTests/WifiConnectionTests.cs`

## 测试建议（执行清单）

### 认证测试

1. Windows 端启用 `设置 → 网络 → 启用 WiFi TLS 加密`
2. 客户端使用正确配对码握手应通过；使用错误配对码应被拒绝（错误信息：`Invalid pairing code`）
3. 使用 `重置配对` 生成新证书后，旧配对码应失效（需要重新配对）

### 加密测试

- 验证客户端对服务端证书指纹固定（pinned）：证书变更后应拒绝连接/要求重新配对
- 按需执行中间人攻击模拟（替换证书/代理），应因证书不匹配而失败

### 权限测试

- 以非管理员运行时，防火墙规则添加为 best-effort（可能失败但不阻塞功能），通过 `安全摘要` 记录是否管理员与防火墙状态

### 数据保护测试

- 通过 `安全摘要` 记录证书文件路径（默认 `wifi-server.pfx.dpapi`）与日志/配置路径，便于追溯与复现

