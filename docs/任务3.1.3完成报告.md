# 任务3.1.3 完成报告：触控事件注入（WIN-103）

- **任务ID**: WIN-103
- **优先级**: P0
- **负责人**: Windows工程师1
- **完成日期**: 2026-01-24
- **分支**: vk/bdaf-3-1-3

## 目标

将 Android 端上传的 `TouchEventMessage`（Down/Move/Up，多点触控）转换为 Windows 端可用的输入注入事件，并提供鼠标模拟作为备用方案。

## 实现内容

### 1) InputService（触控注入 + 鼠标回退）

- 新增 `InputService`：接收协议层 `TouchEventMessage`，根据 Action/PointerId 执行多点触控注入。
- 注入策略：
  - 优先尝试 Windows Touch Injection API（`InitializeTouchInjection` / `InjectTouchInput`）
  - 当 Touch Injection 初始化/注入失败时，自动降级为鼠标事件模拟（`SendInput`，仅主指针）

### 2) 多点触控管理（最多10点）

- 新增 `TouchContactRegistry`：
  - Android `PointerId` → Windows 注入 `slot(1..N)` 映射
  - slot 复用（Up 后释放回收）
  - 主指针判定（slot 最小者为 primary）

### 3) 坐标转换（Android → Windows）

- 新增 `TouchCoordinateMapper`：
  - 基于 Android 屏幕宽高（来自握手 `HandshakeMessage.ScreenWidth/ScreenHeight`）做归一化
  - 映射到 Windows 虚拟桌面区域（默认 `SM_*VIRTUALSCREEN`）
  - 支持 0/90/180/270 旋转参数（可选）

### 4) WiFi 接收触控事件并转发/注入

- 扩展 `WifiConnection`：
  - 新增 `TouchEventReceived` 事件（应用层可订阅）
  - 解析 `MessageType.TouchEvent` 的 JSON payload 并触发事件
  - 可选注入：构造 `WifiConnection` 时传入 `InputService`，则收到触控消息后自动调用 `InputService.HandleTouchEvent(...)`
  - 握手阶段自动将 Android 屏幕宽高同步给 `InputService.UpdateRemoteScreenSize(...)`

## 关键文件

- `src/ExpandScreen.Services/Input/InputService.cs`
- `src/ExpandScreen.Services/Input/TouchCoordinateMapper.cs`
- `src/ExpandScreen.Services/Input/TouchContactRegistry.cs`
- `src/ExpandScreen.Services/Connection/WifiConnection.cs`
- `src/ExpandScreen.IntegrationTests/TouchInputTests.cs`

## 说明与限制

- Touch Injection API 的可用性与权限/系统能力相关：当注入失败时会自动回退为鼠标模拟（仅主指针）。
- 当前 Android 端尚未接入真实触控采集与发送；本任务通过集成测试模拟发送 `TouchEventMessage` 以验证链路与解析。

