# 任务3.1.5 完成报告：配置管理（WIN-105）

- **任务ID**: WIN-105
- **优先级**: P1
- **负责人**: Windows工程师1
- **完成日期**: 2026-01-24
- **分支**: vk/a80d-3-1-5

## 目标

为 Windows 客户端提供统一的配置管理能力：JSON 配置文件读写、默认配置、配置验证、设置页 UI（分类标签页 + 实时预览 + 保存/取消/恢复默认）以及配置热更新（监听文件变化并动态应用部分配置）。

## 实现内容

### 1) ConfigService（JSON + 默认值 + 验证 + 热更新）

- 新增 `ConfigService`：
  - 默认配置文件路径：`%AppData%\\ExpandScreen\\config.json`
  - 文件不存在时自动生成默认配置
  - JSON 解析失败时备份为 `.bad-<timestamp>` 并重置为默认配置
  - 配置规范化/验证：对端口、超时、帧率、码率等做范围修正并返回 warnings
- 配置热更新：
  - `FileSystemWatcher` 监听配置文件
  - 变更 debounce 后自动 reload
  - 触发 `ConfigChanged` 事件，供 UI 动态应用

### 2) 配置项定义

- `General`：开机自启、最小化到托盘、主题（深色/浅色）
- `Video`：分辨率、帧率、码率、编码器偏好（Auto/NVENC/QSV/FFmpeg）
- `Network`：TCP 端口、超时、重连次数、重连间隔
- `Performance`：性能模式、编码线程数

### 3) 设置 UI（分类标签页 + 实时预览）

- 重做 `SettingsWindow`：
  - Tab 分类：常规 / 视频 / 网络 / 性能 / 关于
  - “主题”切换实时预览（取消可回退）
  - 右侧摘要卡片实时展示视频组合（分辨率/帧率/码率/编码器）
  - 操作按钮：取消 / 恢复默认 / 保存设置

### 4) 动态应用（部分配置）

- 启动时加载配置并应用主题
- 自动启动配置：写入/移除 `HKCU\\...\\Run\\ExpandScreen`（best-effort）
- 最小化到托盘：主窗口关闭行为由配置项 `General.MinimizeToTray` 控制；应用退出时不再被强制拦截

## 关键文件

- `src/ExpandScreen.Services/Configuration/AppConfig.cs`
- `src/ExpandScreen.Services/Configuration/ConfigService.cs`
- `src/ExpandScreen.UI/ViewModels/SettingsViewModel.cs`
- `src/ExpandScreen.UI/Views/SettingsWindow.xaml`
- `src/ExpandScreen.UI/Views/SettingsWindow.xaml.cs`
- `src/ExpandScreen.UI/Services/ThemeManager.cs`
- `src/ExpandScreen.UI/Services/AutoStartService.cs`

