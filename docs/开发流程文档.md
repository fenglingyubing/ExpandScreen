# 开发流程文档

本文档记录ExpandScreen项目的开发流程和任务完成情况。

## 任务完成记录

### 任务2.1.1：Windows项目架构搭建 ✅

- **任务ID**: WIN-001
- **优先级**: P0
- **负责人**: Windows工程师1
- **预计工作量**: 3天
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成

详细报告见：原开发流程文档

---

### 任务2.1.2：虚拟显示驱动开发 ✅

- **任务ID**: WIN-002
- **优先级**: P0
- **负责人**: Windows工程师1
- **预计工作量**: 10天
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成

详细报告见：`docs/任务2.1.2完成报告.md`

---

### 任务2.1.3：屏幕捕获模块 ✅

- **任务ID**: WIN-003
- **优先级**: P0
- **负责人**: Windows工程师2
- **预计工作量**: 5天
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成
- **分支**: vk/206f-2-1-3

#### 完成内容

**1. DXGI Desktop Duplication API研究**
- ✅ 研究并掌握DXGI Desktop Duplication API
- ✅ 了解D3D11设备初始化流程
- ✅ 掌握IDXGIOutput和IDXGIOutputDuplication的使用

**2. 核心类实现**

**CapturedFrame数据结构** (`src/ExpandScreen.Core/Capture/CapturedFrame.cs`)
- ✅ 存储帧数据（BGRA格式）
- ✅ 记录帧元数据（宽度、高度、步长、时间戳、序列号）
- ✅ 支持脏矩形区域记录
- ✅ 实现IDisposable接口
- ✅ 提供Clone()方法

**FrameBuffer队列** (`src/ExpandScreen.Core/Capture/FrameBuffer.cs`)
- ✅ 基于System.Threading.Channels实现线程安全队列
- ✅ 有界缓冲，默认容量3帧
- ✅ DropOldest策略自动丢弃旧帧
- ✅ 提供同步/异步添加和取出方法
- ✅ 统计丢帧数量

**DesktopDuplicator类** (`src/ExpandScreen.Core/Capture/DesktopDuplicator.cs`)
- ✅ D3D11设备初始化（硬件/WARP回退）
- ✅ 获取指定监视器的IDXGIOutput
- ✅ 创建IDXGIOutputDuplication
- ✅ 实现帧捕获循环
- ✅ 处理桌面重新创建事件（ACCESS_LOST）
- ✅ 实现脏矩形检测优化
- ✅ 创建Staging纹理用于CPU读取

**ScreenCaptureService服务类** (`src/ExpandScreen.Core/Capture/ScreenCaptureService.cs`)
- ✅ 实现IScreenCapture接口
- ✅ 帧率控制（60fps，16.67ms间隔）
- ✅ 独立捕获线程，高优先级
- ✅ 实时FPS统计
- ✅ 性能监控（总帧数、丢帧数、运行时间）
- ✅ 完善的错误处理和日志记录

**3. 依赖管理**
- ✅ 添加Vortice.Direct3D11 (v3.3.3)
- ✅ 添加Vortice.DXGI (v3.3.3)
- ✅ 添加System.Threading.Channels (v7.0.0)

**4. 日志工具更新**
- ✅ 更新LogHelper类，添加Info/Warning/Error/Debug方法

**5. 文档**
- ✅ 任务完成报告（docs/task-2-1-3-report.md）
- ✅ 使用示例和测试说明

#### 技术亮点

**性能优化**:
- 零拷贝优化：使用Staging纹理直接映射GPU内存
- 脏矩形优化：只传输变化的区域
- 线程优先级：捕获线程设置为AboveNormal
- 精确帧率控制：16.67ms间隔的60fps控制

**线程安全**:
- 使用Channel<T>实现无锁队列
- 使用Interlocked进行原子操作
- 使用lock保护关键区域

**错误处理**:
- ACCESS_LOST自动重新初始化
- 硬件失败回退到WARP软件渲染
- 详细的错误日志记录
- 完善的资源管理（IDisposable）

详细报告见：`docs/task-2-1-3-report.md`

---

### 任务2.1.4：视频编码模块 ✅

- **任务ID**: WIN-004
- **优先级**: P0
- **负责人**: Windows工程师2
- **预计工作量**: 7天
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成
- **分支**: vk/1e49-2-1-4 (已合并到main)

#### 完成内容

**1. FFmpeg库集成**
- ✅ 添加FFmpeg.AutoGen NuGet包 (v6.1.1.1)
- ✅ 配置FFmpeg库路径和自动加载
- ✅ 支持设置自定义DLL路径

**2. 核心数据结构**
- ✅ EncodedFrame.cs - 编码帧数据结构
- ✅ VideoEncoderConfig.cs - 编码器配置
- ✅ FrameType枚举 - 帧类型定义

**3. FFmpeg编码器实现**
- ✅ FFmpegEncoder.cs - H.264编码器
- ✅ 编码器初始化和配置
- ✅ 像素格式转换（BGRA → YUV420P）
- ✅ 帧编码实现
- ✅ SwsContext优化

**4. 编码器工厂和服务**
- ✅ IVideoEncoder接口
- ✅ VideoEncoderFactory - 编码器工厂
- ✅ VideoEncodingService - 编码服务
- ✅ 编码线程和队列管理

**5. 测试和文档**
- ✅ VideoEncoderTests.cs - 测试类
- ✅ 性能测试（编码延迟、CPU占用）
- ✅ 单元测试
- ✅ 完成报告文档

详细报告见：`docs/task-2-1-4-report.md`

---

### 任务2.1.5：USB/ADB通信模块 ✅

- **任务ID**: WIN-005
- **优先级**: P0
- **负责人**: 全栈工程师
- **预计工作量**: 5天
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成
- **分支**: vk/1e49-2-1-5

#### 完成内容

**1. ADB工具集成**
- ✅ AdbHelper.cs - ADB命令封装类
- ✅ ADB可执行文件查找
- ✅ ADB命令执行（异步、超时控制）
- ✅ 设备列表获取和解析
- ✅ 设备详细信息获取
- ✅ 端口转发管理

**2. 设备信息管理**
- ✅ AndroidDevice.cs - 设备信息类
- ✅ 设备属性（ID、型号、制造商、Android版本等）
- ✅ 授权状态检查

**3. USB连接实现**
- ✅ UsbConnection.cs - USB连接管理类
- ✅ 实现IConnectionManager接口
- ✅ ADB端口转发
- ✅ TCP Socket连接
- ✅ 数据发送和接收
- ✅ 自动重连机制
- ✅ 连接状态事件通知

**4. 设备发现服务**
- ✅ DeviceDiscoveryService.cs - 设备发现服务
- ✅ 定期扫描USB设备
- ✅ 设备连接/断开/更新事件
- ✅ 设备列表管理

**5. 错误处理和测试**
- ✅ ConnectionException.cs - 连接异常
- ✅ UsbConnectionTests.cs - 测试类
- ✅ 完整的异常处理和日志记录

**6. 文档**
- ✅ USB_ADB_Module_README.md - 模块使用文档
- ✅ task-2-1-5-report.md - 完成报告

详细报告见：`docs/task-2-1-5-report.md`

---

### 任务2.1.6：网络传输模块（基础） ✅

- **任务ID**: WIN-006
- **优先级**: P0
- **负责人**: 全栈工程师
- **预计工作量**: 6天
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成
- **分支**: vk/3b82-2-1-6

#### 完成内容

**1. 通信协议定义**
- ✅ MessageTypes.cs - 消息类型枚举
- ✅ MessageHeader结构 (24字节)
  - Magic Number (4字节): 0x45585053
  - Type (1字节): 消息类型
  - Version (1字节): 协议版本
  - Reserved (2字节): 预留
  - Timestamp (8字节): 毫秒时间戳
  - PayloadLength (4字节): 负载长度
  - SequenceNumber (4字节): 序列号

**2. 消息序列化/反序列化**
- ✅ MessageSerializer.cs - 序列化工具类
- ✅ 消息头序列化（大端字节序）
- ✅ 消息头反序列化
- ✅ JSON负载序列化（System.Text.Json）
- ✅ 魔数验证
- ✅ 消息组合（头+负载）

**3. 协议消息定义**
- ✅ ProtocolMessages.cs - 消息类定义
- ✅ HandshakeMessage - 握手消息
- ✅ HandshakeAckMessage - 握手确认
- ✅ VideoFrameMessage - 视频帧消息
- ✅ TouchEventMessage - 触控事件
- ✅ HeartbeatMessage - 心跳消息
- ✅ HeartbeatAckMessage - 心跳确认

**4. NetworkSender实现**
- ✅ NetworkSender.cs - TCP发送器
- ✅ 消息打包和序列化
- ✅ 发送队列管理（ConcurrentQueue）
- ✅ 流控机制（队列大小限制、字节数统计）
- ✅ 后台发送循环
- ✅ 队列延迟监控
- ✅ 发送统计信息

**5. NetworkReceiver实现**
- ✅ NetworkReceiver.cs - TCP接收器
- ✅ 消息头接收和解析
- ✅ 负载接收（分段接收）
- ✅ 消息解包
- ✅ 事件回调机制（MessageReceived、ReceiveError、ConnectionClosed）
- ✅ 序列号跳变检测（丢包检测）
- ✅ 接收统计信息

**6. NetworkSession会话管理**
- ✅ NetworkSession.cs - 会话管理类
- ✅ 握手协议实现
  - 客户端发起握手
  - 服务器响应握手
  - 会话ID生成和管理
- ✅ 心跳机制
  - 定期发送心跳（默认5秒）
  - 心跳超时检测（默认15秒）
  - RTT（往返时间）计算
- ✅ 错误处理和重连准备
- ✅ 会话统计信息

**7. 单元测试**
- ✅ NetworkTransportTests.cs - 完整测试套件
- ✅ 消息序列化/反序列化测试
- ✅ JSON负载测试
- ✅ 完整消息组合测试
- ✅ 魔数验证测试
- ✅ Sender-Receiver端到端通信测试
- ✅ NetworkSession握手流程测试

#### 技术亮点

**高性能设计**:
- 异步I/O操作，非阻塞发送和接收
- 后台线程处理发送队列
- 零拷贝优化（直接操作NetworkStream）
- 大端字节序确保跨平台兼容

**流控和可靠性**:
- 发送队列限制防止内存溢出
- 序列号机制检测丢包
- 自动丢弃旧消息保证实时性
- 队列延迟监控

**协议扩展性**:
- 预留字段支持未来扩展
- 版本号机制支持协议升级
- 魔数验证防止非法数据
- 24字节固定头部便于解析

**错误处理**:
- 完整的异常处理
- 连接断开检测
- 心跳超时机制
- 详细的错误事件通知

#### 下一步任务

下一个任务：**2.1.7 基础UI开发** (WIN-007)
- 依赖：WIN-001 ✅
- 负责人：Windows工程师1 + UI设计师
- 工作量：5天
- 优先级：P1

---

## 项目里程碑

### 阶段一：基础功能开发 (4-6周)

**目标**: 建立项目基础架构，实现USB连接和基本屏幕传输功能

| 任务ID | 任务名称 | 状态 | 完成时间 |
|--------|---------|------|----------|
| WIN-001 | 项目架构搭建 | ✅ 完成 | 2026-01-22 |
| WIN-002 | 虚拟显示驱动开发 | ✅ 完成 | 2026-01-22 |
| WIN-003 | 屏幕捕获模块 | ✅ 完成 | 2026-01-22 |
| WIN-004 | 视频编码模块 | ✅ 完成 | 2026-01-22 |
| WIN-005 | USB/ADB通信模块 | ✅ 完成 | 2026-01-22 |
| WIN-006 | 网络传输模块（基础） | ✅ 完成 | 2026-01-22 |
| WIN-007 | 基础UI开发 | 🔲 待开始 | - |
| WIN-008 | 集成测试和调试 | 🔲 待开始 | - |

**进度**: 6/8 任务完成 (75%)

---

## 技术架构

### 当前已实现组件

```
ExpandScreen项目
├── 虚拟显示驱动层 (WIN-002) ✅
│   ├── IddCx驱动程序
│   ├── IOCTL通信接口
│   └── 用户态API
│
├── 屏幕捕获层 (WIN-003) ✅
│   ├── DesktopDuplicator (DXGI捕获)
│   ├── FrameBuffer (线程安全队列)
│   └── ScreenCaptureService (服务管理)
│
├── 视频编码层 (WIN-004) ✅
│   ├── FFmpegEncoder (H.264编码)
│   ├── VideoEncodingService (编码服务)
│   └── VideoEncoderFactory (编码器工厂)
│
├── 通信层 - USB (WIN-005) ✅
│   ├── AdbHelper (ADB工具封装)
│   ├── UsbConnection (USB连接管理)
│   ├── DeviceDiscoveryService (设备发现)
│   └── AndroidDevice (设备信息)
│
├── 通信层 - 网络协议 (WIN-006) ✅
│   ├── MessageSerializer (消息序列化)
│   ├── ProtocolMessages (消息定义)
│   ├── NetworkSender (TCP发送)
│   ├── NetworkReceiver (TCP接收)
│   └── NetworkSession (会话管理、握手、心跳)
│
└── 基础架构 (WIN-001) ✅
    ├── 项目结构
    ├── 日志框架
    └── CI/CD配置
```

### 待实现组件

```
└── 用户界面 (WIN-007) 🔲
    ├── 主窗口
    ├── 设备列表
    └── 系统托盘
```

---

## 开发规范

### Git提交规范

**提交消息格式**:
```
<任务描述>

## 完成内容
- 功能点1
- 功能点2

## 技术细节
- 技术实现说明

任务ID: <任务ID>
优先级: <优先级>

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

### 分支命名规范

- 功能分支：`vk/<任务ID>-<任务简述>`
- 例如：`vk/855d-2-1-1`, `vk/60dc-2-1-2`, `vk/206f-2-1-3`

### 合并流程

1. 在功能分支开发（保持`main`分支干净）
2. 同步远端并rebase到最新的`main`分支

```bash
git fetch origin
git rebase origin/main
```

3. 解决冲突（如有），冲突处理原则：**优先保留`main`分支上的最新改动**，仅在确认必须时再恢复功能分支的改动

> rebase冲突语义提示：在rebase过程中，`--ours`通常指代“被rebase到的基线”（即`origin/main`），`--theirs`指代“正在应用的提交”。

常用命令：

```bash
git status
git diff

# 以main为准（优先保留main最新改动）
git checkout --ours path/to/file

# 或者手工合并后继续
git add path/to/file
git rebase --continue
```

冲突解决后建议做一次差异回看，避免把`main`的最新逻辑回滚掉：

```bash
git diff origin/main...HEAD
```

4. 运行构建/测试确保通过，并记录关键输出（失败则必须先修复或在PR中明确原因与回滚策略）

```bash
dotnet restore ExpandScreen.sln
dotnet build ExpandScreen.sln --configuration Release
dotnet test ExpandScreen.sln --verbosity normal
```

5. 提交说明中必须简述：rebase是否成功、冲突如何解决（无冲突也要注明）、测试结果
6. 合并到`main`分支
   - `main`未受保护：在本地合并后推送
   - `main`受保护：推送功能分支，创建PR并在CI通过后合并（PR描述需包含第5步信息）
7. 确认`main`为最新且构建/测试通过后再结束任务

---

## 更新日志

- **2026-01-23**: 完成任务2.2.6（AND-006），Android 主界面开发实现完成
- **2026-01-23**: 完成任务2.2.5（AND-005），Android 显示Activity开发实现完成
- **2026-01-23**: 完成任务2.2.4（AND-004），Android OpenGL渲染模块实现完成
- **2026-01-22**: 补充rebase冲突处理、测试记录与受保护分支PR合并流程
- **2026-01-22**: 完成任务2.2.3（AND-003），Android视频解码模块实现完成
- **2026-01-22**: 完成任务2.1.6（WIN-006），网络传输模块（基础）实现完成
- **2026-01-22**: 完成任务2.1.5（WIN-005），USB/ADB通信模块实现完成
- **2026-01-22**: 完成任务2.1.4（WIN-004），视频编码模块实现完成
- **2026-01-22**: 完成任务2.1.3（WIN-003），屏幕捕获模块实现完成
- **2026-01-22**: 完成任务2.1.2（WIN-002），虚拟显示驱动开发完成
- **2026-01-22**: 完成任务2.1.1（WIN-001），项目架构搭建完成

---

### 任务2.2.1：Android项目架构搭建 ✅

- **任务ID**: AND-001
- **优先级**: P0
- **负责人**: Android工程师1
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成

#### 完成内容（摘要）
- ✅ 初始化 Android 客户端工程骨架：`android-client/`
- ✅ Compose + Hilt + Room + OkHttp + Coroutines 基础依赖配置
- ✅ 应用入口/主题/基础页面占位

详细总结见：`docs/任务2.2.1完成总结.md`

---

### 任务2.2.2：Android网络接收模块 ✅

- **任务ID**: AND-002
- **优先级**: P0
- **负责人**: 全栈工程师
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成

#### 完成内容（摘要）
- ✅ TCP 连接与接收循环（头/负载解包、解析、SharedFlow 发布）
- ✅ 协议对齐 Windows/C#（24B大端消息头 + JSON负载，`byte[]` Base64）
- ✅ 握手/心跳/会话信息保存 + 断线重连（指数退避）
- ✅ 单元测试覆盖消息头编解码与握手流程

详细报告见：`docs/任务2.2.2完成报告.md`

---

### 任务2.2.3：Android视频解码模块 ✅

- **任务ID**: AND-003
- **优先级**: P0
- **负责人**: Android工程师2
- **实际完成时间**: 2026-01-22
- **状态**: ✅ 已完成

#### 完成内容（摘要）
- ✅ MediaCodec解码器初始化与低延迟配置
- ✅ 输入缓冲管理、解码循环、Surface输出
- ✅ 帧缓冲池与解码线程
- ✅ 关键帧门控、格式变更重配与异常重置
- ✅ 单元测试覆盖缓冲池与帧回收逻辑

详细报告见：`docs/任务2.2.3完成报告.md`

---

### 任务2.2.4：Android OpenGL渲染模块 ✅

- **任务ID**: AND-004
- **优先级**: P0
- **负责人**: Android工程师2
- **实际完成时间**: 2026-01-23
- **状态**: ✅ 已完成

#### 完成内容（摘要）
- ✅ 实现 `GLRenderer`（`GLSurfaceView.Renderer`），基于 External OES 纹理 + `SurfaceTexture` 渲染解码输出
- ✅ 提供 `decoderSurface` 给 `MediaCodec` 做零拷贝输出
- ✅ 着色器程序（顶点/片段）与全屏四边形渲染管线
- ✅ 旋转与宽高比适配（`setVideoSize` / `setVideoRotationDegrees`）
- ✅ 新帧驱动渲染：支持 `RENDERMODE_WHEN_DIRTY + requestRender()` 降低空转

详细报告见：`docs/任务2.2.4完成报告.md`

---

### 任务2.2.5：Android 显示Activity开发 ✅

- **任务ID**: AND-005
- **优先级**: P1
- **负责人**: Android工程师1
- **实际完成时间**: 2026-01-23
- **状态**: ✅ 已完成

#### 完成内容（摘要）
- ✅ DisplayActivity：沉浸式全屏 + 屏幕常亮 + 生命周期管理
- ✅ GLSurfaceView 绑定 GLRenderer，基于新帧触发渲染（`RENDERMODE_WHEN_DIRTY + requestRender()`）
- ✅ 收流 → 解码 → 渲染基础链路串联（NetworkManager VideoFrame → H264Decoder → GLRenderer SurfaceTexture）
- ✅ HUD（FPS/延迟/连接状态）与双击唤醒菜单（退出/旋转锁定/HUD开关）

详细报告见：`docs/任务2.2.5完成报告.md`

---

### 任务2.2.6：Android 主界面开发 ✅

- **任务ID**: AND-006
- **优先级**: P1
- **负责人**: Android工程师1 + UI设计师
- **实际完成时间**: 2026-01-23
- **状态**: ✅ 已完成

#### 完成内容（摘要）
- ✅ Jetpack Compose 主界面（Quick Connect + 历史设备列表 + 设置入口预留）
- ✅ MainViewModel（StateFlow）状态管理与连接命令处理
- ✅ 连接等待界面（Connecting 覆盖层 + Cancel）
- ✅ 导航：连接成功进入 `DisplayActivity`；断开连接自动返回主界面
- ✅ 设备历史 upsert（避免重复插入，更新 `lastConnected`）

详细报告见：`docs/任务2.2.6完成报告.md`

---

## 测试和构建说明

### 环境要求

**Windows开发环境**:
- Windows 10/11 操作系统
- Visual Studio 2022
- Windows Driver Kit (WDK) 10
- .NET 8.0 SDK

**Android开发环境**:
- Android Studio 2023.1.1+
- JDK 17
- Android SDK (API 34 / Build Tools 对应版本)

### 构建步骤

```bash
# 1. 恢复NuGet包
dotnet restore ExpandScreen.sln

# 2. 构建解决方案
dotnet build ExpandScreen.sln --configuration Release

# 3. 运行测试
dotnet test ExpandScreen.sln

# 4. 构建驱动（需要WDK）
msbuild src\ExpandScreen.Driver\ExpandScreen.Driver.vcxproj /p:Configuration=Release

# 5. Android 单元测试（JDK 17）
cd android-client
./gradlew :app:testDebugUnitTest
```

### 已知限制

- 驱动（`src/ExpandScreen.Driver`）需要在Windows + WDK环境下编译/签名/安装
- Linux环境可进行`dotnet restore/build/test`（Windows目标项目在非Windows上构建时需加`-p:EnableWindowsTargeting=true`）
- 驱动需要测试签名或正式证书才能安装
- 完整的功能测试需要在Windows环境下进行

---

**文档维护人**: Windows工程师1, Windows工程师2, 全栈工程师 (with Claude Sonnet 4.5)
**最后更新**: 2026-01-23
