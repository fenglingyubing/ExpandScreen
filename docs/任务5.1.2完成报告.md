# 任务5.1.2 完成报告：性能测试（TEST-002）

## 任务信息

- **任务ID**：TEST-002
- **优先级**：P0
- **负责人**：测试工程师 + Windows 工程师2
- **完成日期**：2026-01-26

## 交付目标

为性能测试提供“可重复采样 + 可导出数据”的最小闭环工具，便于后续在不同场景（空闲/1080p@60/4K@60/多设备/长稳）下快速采集 CPU、内存等关键指标，并留存原始数据用于对比与回归。

## 完成内容（摘要）

### 1) Windows 端性能采样与导出工具

- 主窗口右上角新增入口：`⏱ 性能测试`
- 提供：
  - 实时指标（CPU / WorkingSet / ManagedHeap / Heartbeat RTT / FPS / Latency）
  - 最近趋势（CPU、WorkingSet 折线）
  - 录制（Start/Stop）与导出（JSON/CSV）
- 默认导出目录：`%LocalAppData%\\ExpandScreen\\diagnostics`
- 采样间隔：500ms

> 说明：FPS/Latency/Heartbeat RTT 字段在对应链路未接入时显示 N/A；当前工具优先保证资源占用采样与导出可用，便于先做“资源占用/长稳”两类性能测试。

### 2) 数据结构与导出实现

- 新增 `PerformanceSampleSeries`：支持 JSON 与 CSV 两种导出格式，并提供快速摘要（样本数/时长/CPU与内存 avg/max）。

## 关键输出文件

- `src/ExpandScreen.Services/Diagnostics/PerformanceSampleSeries.cs`
- `src/ExpandScreen.UI/ViewModels/PerformanceTestViewModel.cs`
- `src/ExpandScreen.UI/Views/PerformanceTestWindow.xaml`
- `src/ExpandScreen.UI/Views/PerformanceTestWindow.xaml.cs`
- `src/ExpandScreen.UI/ViewModels/MainViewModel.cs`
- `src/ExpandScreen.UI/MainWindow.xaml`
- `docs/开发流程文档.md`（新增 5.1.2 节）

## 使用方式

1. 启动 Windows 客户端 `ExpandScreen.UI`
2. 点击主窗口右上角 `⏱` 打开 **性能测试**
3. 点击“开始录制”，运行目标场景（建议 1-5 分钟）
4. 点击“停止”，然后导出 JSON 或 CSV

## 测试建议（执行清单）

### 资源占用

- 空闲：录制 1 分钟
- 1080p@60：录制 3 分钟
- 4K@60：录制 3 分钟
- 多设备：逐步增加设备数，每档录制 3 分钟

对比指标：CPU avg/max、WorkingSet avg/max、ManagedHeap 变化趋势。

### 延迟（方法建议）

- 高速摄像机对比：触控到画面变化帧差
- 时间戳标记：在链路关键阶段打点（后续可按需要扩展 decode/render 侧回传）

### 稳定性

- 长稳运行（建议 24h）
- 每小时导出一次诊断包（含性能快照）与性能采样文件
- 重点观察：WorkingSet 增长趋势、异常峰值、掉线/重连与丢消息趋势（若链路接入）

