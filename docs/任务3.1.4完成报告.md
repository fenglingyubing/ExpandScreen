# 任务3.1.4 完成报告：自动更新（WIN-204）

- **任务ID**: WIN-204
- **优先级**: P2
- **负责人**: Windows工程师1
- **完成日期**: 2026-01-24
- **分支**: vk/d5f8-3-1-4

## 目标

为 Windows 客户端增加“检查更新 / 下载更新 / 启动安装”的能力，并提供更新提示对话框、下载进度与发布说明展示。

## 实现内容

### 1) UpdateService（清单检查 + 下载 + 校验）

- 新增 `UpdateService`：支持从 **HTTP(S)** 或 **本地文件**读取更新清单（manifest）。
- 清单字段（JSON）：
  - `version`（必填，数字版本，如 `2.0.0`）
  - `downloadUrl`（必填，HTTP(S) URL 或本地 `file://`）
  - `sha256`（必填，hex，支持 `sha256:` 前缀）
  - `releaseNotes`（可选）
  - `signature`（可选，Base64；用于清单签名验证）
- 下载与校验：
  - 以流式方式下载到临时目录（支持进度回调）
  - 下载后计算 SHA256 并与清单中的 `sha256` 比对，不一致则失败并清理文件
- 可选清单签名验证（RSA）：
  - payload：`version + "\\n" + downloadUrl + "\\n" + sha256`
  - 使用 `TrustedManifestPublicKeyPem` 验签（可通过 `RequireManifestSignature` 强制要求）

### 2) 更新UI（对话框 + 进度 + 发布说明）

- 设置页「关于」新增入口：`检查更新`。
- 新增更新窗口：
  - 状态区：当前状态/错误信息
  - 版本区：当前版本、最新版本
  - 进度条：下载进度（0-100%）
  - 发布说明：可滚动查看

### 3) 应用更新（启动安装程序并退出）

- 下载完成后使用 Shell 启动安装程序（`UseShellExecute=true`），随后退出应用以完成更新流程。

## 使用方式

更新源通过环境变量配置（可选）：

- `EXPANDSCREEN_UPDATE_MANIFEST`：更新清单 URL 或本地路径（如：`C:\\path\\latest.json`）

> 未配置时，UI 会提示“未配置更新源”，不会触发网络请求。

## 关键文件

- `src/ExpandScreen.Services/Update/UpdateService.cs`
- `src/ExpandScreen.Services/Update/UpdateManifest.cs`
- `src/ExpandScreen.UI/Views/UpdateWindow.xaml`
- `src/ExpandScreen.UI/ViewModels/UpdateViewModel.cs`

